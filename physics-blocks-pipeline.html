<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Physics Formula Pipeline - å…¬å¼æµæ°´çº¿</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 280px;
      padding: 16px;
      background: #111827;
      color: #e5e7eb;
      overflow-y: auto;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 12px;
    }
    .formula-item {
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(31,41,55,0.7);
    }
    .formula-item label {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      cursor: pointer;
    }
    .formula-name {
      font-size: 13px;
      font-weight: 600;
    }
    .formula-brief {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .top-bar {
      padding: 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
    }
    .blocks-area {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    .blocks-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }
    .block {
      width: 260px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
      border: 2px solid rgba(148,163,184,0.6);
      padding: 10px 12px 12px;
    }
    .block-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .block-number {
      font-size: 11px;
      padding: 2px 6px;
      background: #111827;
      color: white;
      border-radius: 4px;
    }
    .block-formula {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
      font-family: "SF Mono", Menlo, Consolas, monospace;
    }
    .field {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .field label {
      width: 38px;
      color: #374151;
    }
    .field input[type="number"] {
      flex: 1;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
    }
    .field input[type="number"]:disabled {
      background: #f3f4f6;
      color: #6b7280;
    }
    .field input[type="number"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.3);
    }
    .output-row {
      margin-top: 6px;
      font-size: 12px;
      padding: 6px;
      background: #f0fdf4;
      border-radius: 6px;
    }
    .output-label {
      color: #166534;
      margin-bottom: 2px;
      font-weight: 600;
    }
    .output-value {
      font-family: "SF Mono", Menlo, Consolas, monospace;
      color: #059669;
      font-weight: 600;
    }

    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
      margin-right: 8px;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }

    .results {
      margin-top: 16px;
      padding: 12px;
      background: #111827;
      color: #f9fafb;
      border-radius: 8px;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.5;
    }
    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }
    .auto-badge {
      font-size: 9px;
      padding: 1px 4px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 3px;
      margin-left: 4px;
    }
  </style>
</head>
<body>

  <!-- å·¦ä¾§ï¼šå…¬å¼é€‰æ‹© -->
  <div class="sidebar">
    <h1>ğŸ“ ç‰©ç†å…¬å¼åº“</h1>
    <p style="font-size: 12px; color: #9ca3af; margin-bottom: 12px;">
      å‹¾é€‰å…¬å¼åˆ›å»ºBlockï¼ŒæŒ‰é¡ºåºè‡ªåŠ¨ä¼ é€’è®¡ç®—ç»“æœ
    </p>
    <div id="formula-list"></div>
  </div>

  <!-- å³ä¾§ï¼šBlocks + æ§åˆ¶ -->
  <div class="main">
    <div class="top-bar">
      <h1>ğŸ”— å…¬å¼æµæ°´çº¿</h1>
      <button id="runBtn" class="btn-primary">â–¶ Run Pipeline</button>
      <button id="clearBtn" class="btn-secondary">Clear All</button>
      <p class="hint">
        BlockæŒ‰æ·»åŠ é¡ºåºæ‰§è¡Œã€‚å¦‚æœæŸä¸ªBlockçš„è¾“å…¥åœ¨ä¹‹å‰Blockçš„è¾“å‡ºä¸­ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥å€¼ã€‚
      </p>
    </div>

    <div class="blocks-area">
      <div class="blocks-container" id="blocks-container"></div>
      <div id="results" class="results" style="display: none;"></div>
    </div>
  </div>

<script>
// 10 ä¸ªå¤§å­¦ç‰©ç†1åŠ›å­¦å…¬å¼å®šä¹‰
const FORMULAS = [
  {
    id: 'x_xt_v0_a_t',
    name: '1. åŒ€åŠ é€Ÿç›´çº¿è¿åŠ¨ä½ç§»',
    formulaText: 'x = x0 + v0Â·t + 1/2Â·aÂ·tÂ²',
    inputs: ['x0', 'v0', 'a', 't'],
    output: 'x',
    compute: ({ x0, v0, a, t }) => x0 + v0 * t + 0.5 * a * t * t
  },
  {
    id: 'v_v0_at',
    name: '2. åŒ€åŠ é€Ÿæœ«é€Ÿåº¦',
    formulaText: 'v = v0 + aÂ·t',
    inputs: ['v0', 'a', 't'],
    output: 'v',
    compute: ({ v0, a, t }) => v0 + a * t
  },
  {
    id: 'v2_v02_2a_x_x0',
    name: '3. æ— æ—¶é—´å˜é‡é€Ÿåº¦å…³ç³»',
    formulaText: 'vÂ² = v0Â² + 2Â·aÂ·(x âˆ’ x0)',
    inputs: ['v0', 'a', 'x', 'x0'],
    output: 'v',
    compute: ({ v0, a, x, x0 }) => {
      const val = v0 * v0 + 2 * a * (x - x0);
      return val >= 0 ? Math.sqrt(val) : NaN;
    }
  },
  {
    id: 'F_ma',
    name: '4. åŠ›çš„åŸºæœ¬å®šä¹‰',
    formulaText: 'F = mÂ·a',
    inputs: ['m', 'a'],
    output: 'F',
    compute: ({ m, a }) => m * a
  },
  {
    id: 'K_1_2mv2',
    name: '5. åŠ¨èƒ½',
    formulaText: 'K = 1/2Â·mÂ·vÂ²',
    inputs: ['m', 'v'],
    output: 'K',
    compute: ({ m, v }) => 0.5 * m * v * v
  },
  {
    id: 'W_Fd',
    name: '6. åŠŸï¼ˆåŒæ–¹å‘ï¼‰',
    formulaText: 'W = FÂ·d',
    inputs: ['F', 'd'],
    output: 'W',
    compute: ({ F, d }) => F * d
  },
  {
    id: 'Wnet_deltaK',
    name: '7. åŠ¨èƒ½å®šç†',
    formulaText: 'W_net = 1/2Â·mÂ·vÂ² âˆ’ 1/2Â·mÂ·v0Â²',
    inputs: ['m', 'v', 'v0'],
    output: 'W_net',
    compute: ({ m, v, v0 }) => 0.5 * m * (v*v - v0*v0)
  },
  {
    id: 'Ug_mgh',
    name: '8. é‡åŠ›åŠ¿èƒ½',
    formulaText: 'Ug = mÂ·gÂ·hï¼ˆg é»˜è®¤ 9.8ï¼‰',
    inputs: ['m', 'h', 'g'],
    output: 'Ug',
    compute: ({ m, h, g }) => m * (g || 9.8) * h
  },
  {
    id: 'P_W_t',
    name: '9. åŠŸç‡ï¼ˆå¹³å‡ï¼‰',
    formulaText: 'P = W / t',
    inputs: ['W', 't'],
    output: 'P',
    compute: ({ W, t }) => t === 0 ? NaN : W / t
  },
  {
    id: 'ac_v2_r',
    name: '10. å‘å¿ƒåŠ é€Ÿåº¦',
    formulaText: 'a_c = vÂ² / r',
    inputs: ['v', 'r'],
    output: 'a_c',
    compute: ({ v, r }) => r === 0 ? NaN : v * v / r
  }
];

// å·¥å…·å‡½æ•°ï¼šæ•°å­—æ ¼å¼åŒ–
function fmt(x) {
  if (x === null || x === undefined) return 'â€”';
  if (Number.isNaN(x)) return 'NaN';
  if (!Number.isFinite(x)) return x > 0 ? '+âˆ' : '-âˆ';
  return Number(x).toFixed(4).replace(/\.?0+$/, '');
}

// æ¸²æŸ“å·¦ä¾§å…¬å¼åˆ—è¡¨
const formulaListEl = document.getElementById('formula-list');
const blocksContainer = document.getElementById('blocks-container');
const resultsEl = document.getElementById('results');

// å­˜å‚¨å·²åˆ›å»ºçš„ Block
const activeBlocks = []; // æŒ‰é¡ºåºå­˜å‚¨ {formula, element}

FORMULAS.forEach(f => {
  const item = document.createElement('div');
  item.className = 'formula-item';
  const id = 'chk_' + f.id;

  item.innerHTML = `
    <label for="${id}">
      <input type="checkbox" id="${id}" data-formula-id="${f.id}">
      <div>
        <div class="formula-name">${f.name}</div>
        <div class="formula-brief">${f.formulaText}</div>
      </div>
    </label>
  `;
  formulaListEl.appendChild(item);
});

// å‹¾é€‰åˆ›å»º Block
formulaListEl.addEventListener('change', e => {
  if (e.target.matches('input[type="checkbox"][data-formula-id]')) {
    const formulaId = e.target.dataset.formulaId;
    const formula = FORMULAS.find(f => f.id === formulaId);
    if (!formula) return;

    if (e.target.checked) {
      const blockEl = createBlockElement(formula, activeBlocks.length + 1);
      blocksContainer.appendChild(blockEl);
      activeBlocks.push({ formula, element: blockEl });
    } else {
      const idx = activeBlocks.findIndex(b => b.formula.id === formulaId);
      if (idx >= 0) {
        activeBlocks[idx].element.remove();
        activeBlocks.splice(idx, 1);
        // é‡æ–°ç¼–å·
        activeBlocks.forEach((b, i) => {
          b.element.querySelector('.block-number').textContent = `#${i + 1}`;
        });
      }
    }
  }
});

// åˆ›å»º Block DOM
function createBlockElement(f, number) {
  const block = document.createElement('div');
  block.className = 'block';

  const fieldsHtml = f.inputs.map(name => `
    <div class="field">
      <label>${name}</label>
      <input type="number" step="any" data-input-name="${name}" placeholder="0">
    </div>
  `).join('');

  block.innerHTML = `
    <div class="block-header">
      <span>${f.name}</span>
      <span class="block-number">#${number}</span>
    </div>
    <div class="block-formula">${f.formulaText}</div>
    ${fieldsHtml}
    <div class="output-row">
      <div class="output-label">Output: ${f.output}</div>
      <div class="output-value" data-output>â€”</div>
    </div>
  `;

  return block;
}

// Run Pipeline æŒ‰é’®
document.getElementById('runBtn').addEventListener('click', () => {
  if (activeBlocks.length === 0) {
    alert('è¯·å…ˆå‹¾é€‰å…¬å¼åˆ›å»ºBlock');
    return;
  }

  const state = {}; // å…¨å±€çŠ¶æ€å­˜å‚¨æ‰€æœ‰å˜é‡
  const logLines = [];
  logLines.push('=== å¼€å§‹æ‰§è¡Œæµæ°´çº¿ ===\n');

  activeBlocks.forEach((blockData, index) => {
    const { formula, element } = blockData;

    logLines.push(`>>> Block #${index + 1}: ${formula.name}`);
    logLines.push(`å…¬å¼: ${formula.formulaText}`);

    // æ”¶é›†è¾“å…¥
    const inputs = {};
    let hasAutoInput = false;

    formula.inputs.forEach(varName => {
      const inputEl = element.querySelector(`input[data-input-name="${varName}"]`);
      let value;

      // ä¼˜å…ˆä»stateè·å–ï¼ˆä¹‹å‰blockçš„è¾“å‡ºï¼‰
      if (state[varName] !== undefined && state[varName] !== null) {
        value = state[varName];
        inputEl.value = fmt(value);
        inputEl.disabled = true;
        inputEl.style.background = '#f0fdf4';
        hasAutoInput = true;
        logLines.push(`  ${varName} = ${fmt(value)} (æ¥è‡ªä¸Šæ¸¸Block)`);
      } else {
        value = parseFloat(inputEl.value);
        if (isNaN(value)) value = 0;
        inputEl.disabled = false;
        inputEl.style.background = '';
        logLines.push(`  ${varName} = ${fmt(value)} (æ‰‹åŠ¨è¾“å…¥)`);
      }

      inputs[varName] = value;
    });

    // è®¡ç®—è¾“å‡º
    let result;
    try {
      result = formula.compute(inputs);
    } catch (err) {
      result = NaN;
    }

    // å­˜å‚¨åˆ°state
    state[formula.output] = result;

    // æ›´æ–°æ˜¾ç¤º
    const outputEl = element.querySelector('[data-output]');
    outputEl.textContent = fmt(result);

    logLines.push(`  â†’ ${formula.output} = ${fmt(result)}\n`);
  });

  logLines.push('=== æµæ°´çº¿æ‰§è¡Œå®Œæ¯• ===');
  logLines.push('\næœ€ç»ˆçŠ¶æ€:');
  for (const [key, value] of Object.entries(state)) {
    logLines.push(`  ${key} = ${fmt(value)}`);
  }

  resultsEl.textContent = logLines.join('\n');
  resultsEl.style.display = 'block';
});

// Clear All æŒ‰é’®
document.getElementById('clearBtn').addEventListener('click', () => {
  activeBlocks.forEach(({ element }) => {
    element.querySelectorAll('input[data-input-name]').forEach(inp => {
      inp.value = '';
      inp.disabled = false;
      inp.style.background = '';
    });
    element.querySelector('[data-output]').textContent = 'â€”';
  });
  resultsEl.style.display = 'none';
});
</script>

</body>
</html>
