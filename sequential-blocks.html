<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sequential Blackbox Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 2rem;
      background: #f9fafb;
    }
    h1, h2 {
      margin-bottom: 0.5rem;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .inputs-card {
      flex: 1 1 280px;
    }
    .blocks-card {
      flex: 2 1 320px;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }
    input, select {
      width: 100%;
      padding: 0.4rem 0.5rem;
      margin-bottom: 0.75rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
    }
    .block-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .block-label {
      width: 70px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-size: 0.95rem;
      cursor: pointer;
      background: #111827;
      color: #ffffff;
      margin-right: 0.5rem;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .results {
      margin-top: 1rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      font-size: 0.88rem;
      background: #111827;
      color: #f9fafb;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      max-height: 360px;
      overflow-y: auto;
    }
    .hint {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: -0.3rem;
      margin-bottom: 0.75rem;
    }
  </style>
</head>
<body>

  <h1>Sequential Blackbox · 模块拼接演示</h1>
  <p style="max-width: 720px; font-size: 0.93rem;">
    你可以选择 Block1 → Block2 → Block3 的顺序，例如
    <strong>Velocity → Distance → Energy</strong> 或 <strong>Distance → Energy → Velocity</strong>。
    每个 Block 会读取当前状态 <code>{a, t, m, v, d, E}</code>，并写回自己的输出。
  </p>

  <div class="row">
    <!-- Inputs -->
    <div class="card inputs-card">
      <h2>Global Inputs</h2>
      <label for="a">加速度 a (m/s²)</label>
      <input id="a" type="number" step="0.01" value="9.8">

      <label for="t">时间 t (s)</label>
      <input id="t" type="number" step="0.01" value="2.5">

      <label for="m">质量 m (kg)</label>
      <input id="m" type="number" step="0.01" value="70">

      <p class="hint">
        这些是“全局输入”，会在整个流水线内共享。Block 只负责根据当前状态更新一部分变量。
      </p>
    </div>

    <!-- Blocks -->
    <div class="card blocks-card">
      <h2>Blocks · 顺序可调</h2>

      <div class="block-row">
        <span class="block-label">Block 1</span>
        <select id="block1">
          <option value="velocity">Velocity (v = a × t)</option>
          <option value="distance">Distance (d = 0.5 × a × t² 或 v/2 × t)</option>
          <option value="energy">Energy (E = 0.5 × m × v²)</option>
        </select>
      </div>

      <div class="block-row">
        <span class="block-label">Block 2</span>
        <select id="block2">
          <option value="velocity">Velocity (v = a × t)</option>
          <option value="distance" selected>Distance (d = 0.5 × a × t² 或 v/2 × t)</option>
          <option value="energy">Energy (E = 0.5 × m × v²)</option>
        </select>
      </div>

      <div class="block-row">
        <span class="block-label">Block 3</span>
        <select id="block3">
          <option value="velocity">Velocity (v = a × t)</option>
          <option value="distance">Distance (d = 0.5 × a × t² 或 v/2 × t)</option>
          <option value="energy" selected>Energy (E = 0.5 × m × v²)</option>
        </select>
      </div>

      <p class="hint">
        提示：为了得到完整链条，可以保证三种类型各用一次，比如：1=Velocity，2=Distance，3=Energy。
        当然你也可以故意重复/缺少某个 Block，看状态怎么变化。
      </p>

      <button id="runBtn">Run Pipeline</button>
      <button id="resetBtn" class="secondary">Reset Outputs</button>

      <div id="results" class="results"></div>
    </div>
  </div>

  <script>
    function formatState(state) {
      const fmt = (x) =>
        (x === null || x === undefined || Number.isNaN(x))
          ? "—"
          : Number(x).toFixed(4);
      return `a = ${fmt(state.a)}  (m/s²)
t = ${fmt(state.t)}  (s)
m = ${fmt(state.m)}  (kg)
v = ${fmt(state.v)}  (m/s)
d = ${fmt(state.d)}  (m)
E = ${fmt(state.E)}  (J)`;
    }

    function runBlock(type, state, logLines) {
      const a = state.a;
      const t = state.t;
      const m = state.m;

      if (type === "velocity") {
        const v = a * t;
        logLines.push(`Velocity Block:
  输入: a=${a}, t=${t}
  计算: v = a * t = ${v.toFixed(4)} m/s`);
        state.v = v;
      }

      else if (type === "distance") {
        let d;
        if (state.v != null && !Number.isNaN(state.v)) {
          d = 0.5 * state.v * t;
          logLines.push(`Distance Block:
  检测到已有 v=${state.v.toFixed(4)}，使用 d = (v/2) * t
  计算: d = 0.5 * v * t = ${d.toFixed(4)} m`);
        } else {
          d = 0.5 * a * t * t;
          logLines.push(`Distance Block:
  未检测到 v，使用 d = 0.5 * a * t²
  计算: d = 0.5 * a * t² = ${d.toFixed(4)} m`);
        }
        state.d = d;
      }

      else if (type === "energy") {
        if (state.v == null || Number.isNaN(state.v)) {
          const v = a * t;
          logLines.push(`Energy Block:
  未检测到 v，先自动补算 v = a * t = ${v.toFixed(4)} m/s`);
          state.v = v;
        }
        const E = 0.5 * m * state.v * state.v;
        logLines.push(`Energy Block:
  输入: m=${m}, v=${state.v.toFixed(4)}
  计算: E = 0.5 * m * v² = ${E.toFixed(4)} J`);
        state.E = E;
      }
    }

    document.getElementById("runBtn").addEventListener("click", () => {
      const a = parseFloat(document.getElementById("a").value);
      const t = parseFloat(document.getElementById("t").value);
      const m = parseFloat(document.getElementById("m").value);

      const block1 = document.getElementById("block1").value;
      const block2 = document.getElementById("block2").value;
      const block3 = document.getElementById("block3").value;

      const state = {
        a: a,
        t: t,
        m: m,
        v: null,
        d: null,
        E: null
      };

      const logLines = [];
      logLines.push("=== 初始状态 ===");
      logLines.push(formatState(state));
      logLines.push("");

      logLines.push(`>>> 执行 Block 1 (${block1})`);
      runBlock(block1, state, logLines);
      logLines.push("当前状态：");
      logLines.push(formatState(state));
      logLines.push("");

      logLines.push(`>>> 执行 Block 2 (${block2})`);
      runBlock(block2, state, logLines);
      logLines.push("当前状态：");
      logLines.push(formatState(state));
      logLines.push("");

      logLines.push(`>>> 执行 Block 3 (${block3})`);
      runBlock(block3, state, logLines);
      logLines.push("当前状态：");
      logLines.push(formatState(state));
      logLines.push("");

      logLines.push("=== 最终状态 ===");
      logLines.push(formatState(state));

      document.getElementById("results").textContent = logLines.join("\n");
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("results").textContent = "";
    });
  </script>
</body>
</html>
