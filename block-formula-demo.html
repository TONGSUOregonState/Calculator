<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Block Formula Demo - Auto Connect</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    .hint {
      text-align: center;
      color: #555;
      margin-bottom: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .canvas {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: 0 auto;
    }

    .block {
      background: #ffffff;
      border-radius: 12px;
      padding: 18px;
      min-width: 260px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 2px solid #e5e7eb;
    }

    .block-header {
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 16px;
      color: #111827;
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .formula-display {
      text-align: center;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: 600;
      color: #2563eb;
      padding: 10px;
      background: #eff6ff;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .inputs-section {
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 11px;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .input-field {
      margin-bottom: 10px;
      padding: 8px;
      background: #f9fafb;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }

    .input-label {
      font-size: 12px;
      color: #374151;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .input-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="number"] {
      flex: 1;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 14px;
    }

    input[type="number"]:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59,130,246,0.1);
    }

    input[type="number"]:disabled {
      background: #f3f4f6;
      color: #6b7280;
      cursor: not-allowed;
    }

    select {
      flex: 1;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #fff;
      outline: none;
    }

    select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59,130,246,0.1);
    }

    .connection-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #dbeafe;
      color: #1e40af;
      font-weight: 600;
    }

    .output-section {
      padding: 10px;
      background: #f0fdf4;
      border-radius: 8px;
      border: 2px solid #86efac;
    }

    .output-value {
      font-size: 16px;
      font-weight: 700;
      color: #059669;
      text-align: center;
    }

    .auto-label {
      font-size: 11px;
      color: #9ca3af;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Block Formula Demo - 自动连接版</h1>
  <div class="hint">
    每个Block有<strong>2个输入、1个输出</strong>。<br>
    选择输入来源为"Block X"时，自动使用该Block的输出值（模拟拖拽连线）。
  </div>

  <div id="app">
    <div class="canvas">
      <!-- Block 1: v = s / t -->
      <div class="block">
        <div class="block-header">Block 1</div>
        <div class="formula-display">v = input₁ / input₂</div>

        <div class="inputs-section">
          <div class="section-title">⬇ 输入 (2个)</div>

          <div class="input-field">
            <div class="input-label">Input 1 (s - 位移):</div>
            <div class="input-control">
              <input type="number" v-model.number="block1.input1" step="0.1">
            </div>
          </div>

          <div class="input-field">
            <div class="input-label">Input 2 (t - 时间):</div>
            <div class="input-control">
              <input type="number" v-model.number="block1.input2" step="0.1">
            </div>
          </div>
        </div>

        <div class="output-section">
          <div class="section-title">⬆ 输出 (1个)</div>
          <div class="output-value">v = {{ pretty(block1Output) }}</div>
        </div>
      </div>

      <!-- Block 2: a = v / t -->
      <div class="block">
        <div class="block-header">Block 2</div>
        <div class="formula-display">a = input₁ / input₂</div>

        <div class="inputs-section">
          <div class="section-title">⬇ 输入 (2个)</div>

          <div class="input-field">
            <div class="input-label">Input 1 (v - 速度):</div>
            <select v-model="block2.input1Source">
              <option value="manual">手动输入</option>
              <option value="block1">← 来自 Block 1 输出</option>
            </select>
            <div class="input-control" style="margin-top: 6px;">
              <input
                type="number"
                v-model.number="block2.input1"
                step="0.1"
                :disabled="block2.input1Source === 'block1'"
              >
              <span v-if="block2.input1Source === 'block1'" class="connection-badge">
                自动: {{ pretty(block1Output) }}
              </span>
            </div>
          </div>

          <div class="input-field">
            <div class="input-label">Input 2 (t - 时间):</div>
            <select v-model="block2.input2Source">
              <option value="manual">手动输入</option>
            </select>
            <div class="input-control" style="margin-top: 6px;">
              <input type="number" v-model.number="block2.input2" step="0.1">
            </div>
          </div>
        </div>

        <div class="output-section">
          <div class="section-title">⬆ 输出 (1个)</div>
          <div class="output-value">a = {{ pretty(block2Output) }}</div>
        </div>
      </div>

      <!-- Block 3: d = 0.5 * a * t^2 -->
      <div class="block">
        <div class="block-header">Block 3</div>
        <div class="formula-display">d = 0.5 × input₁ × input₂²</div>

        <div class="inputs-section">
          <div class="section-title">⬇ 输入 (2个)</div>

          <div class="input-field">
            <div class="input-label">Input 1 (a - 加速度):</div>
            <select v-model="block3.input1Source">
              <option value="manual">手动输入</option>
              <option value="block2">← 来自 Block 2 输出</option>
            </select>
            <div class="input-control" style="margin-top: 6px;">
              <input
                type="number"
                v-model.number="block3.input1"
                step="0.1"
                :disabled="block3.input1Source === 'block2'"
              >
              <span v-if="block3.input1Source === 'block2'" class="connection-badge">
                自动: {{ pretty(block2Output) }}
              </span>
            </div>
          </div>

          <div class="input-field">
            <div class="input-label">Input 2 (t - 时间):</div>
            <select v-model="block3.input2Source">
              <option value="manual">手动输入</option>
            </select>
            <div class="input-control" style="margin-top: 6px;">
              <input type="number" v-model.number="block3.input2" step="0.1">
            </div>
          </div>
        </div>

        <div class="output-section">
          <div class="section-title">⬆ 输出 (1个)</div>
          <div class="output-value">d = {{ pretty(block3Output) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue 3 from CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { createApp, ref, computed, watch } = Vue;

    createApp({
      setup() {
        // Block 1: v = input1 / input2 (s / t)
        const block1 = ref({
          input1: 10,  // s
          input2: 2    // t
        });

        // Block 2: a = input1 / input2 (v / t)
        const block2 = ref({
          input1: 0,
          input2: 5,
          input1Source: 'block1',  // 默认连接到 Block 1
          input2Source: 'manual'
        });

        // Block 3: d = 0.5 * input1 * input2^2 (0.5 * a * t^2)
        const block3 = ref({
          input1: 0,
          input2: 10,
          input1Source: 'block2',  // 默认连接到 Block 2
          input2Source: 'manual'
        });

        // 计算 Block 1 的输出
        const block1Output = computed(() => {
          if (block1.value.input2 === 0) return NaN;
          return block1.value.input1 / block1.value.input2;
        });

        // 计算 Block 2 的实际输入1（自动从 Block 1 获取或手动）
        const block2Input1Actual = computed(() => {
          return block2.value.input1Source === 'block1'
            ? block1Output.value
            : block2.value.input1;
        });

        // 计算 Block 2 的输出
        const block2Output = computed(() => {
          if (block2.value.input2 === 0) return NaN;
          return block2Input1Actual.value / block2.value.input2;
        });

        // 计算 Block 3 的实际输入1（自动从 Block 2 获取或手动）
        const block3Input1Actual = computed(() => {
          return block3.value.input1Source === 'block2'
            ? block2Output.value
            : block3.value.input1;
        });

        // 计算 Block 3 的输出
        const block3Output = computed(() => {
          return 0.5 * block3Input1Actual.value * Math.pow(block3.value.input2, 2);
        });

        // 当 Block 1 输出变化时，自动更新 Block 2 的显示（如果已连接）
        watch(block1Output, (newVal) => {
          if (block2.value.input1Source === 'block1') {
            block2.value.input1 = newVal;
          }
        });

        // 当 Block 2 输出变化时，自动更新 Block 3 的显示（如果已连接）
        watch(block2Output, (newVal) => {
          if (block3.value.input1Source === 'block2') {
            block3.value.input1 = newVal;
          }
        });

        const pretty = (x) => {
          if (Number.isNaN(x)) return 'NaN';
          if (!Number.isFinite(x)) return x > 0 ? '+∞' : '-∞';
          return Number(x).toFixed(4).replace(/\.?0+$/, '');
        };

        return {
          block1,
          block2,
          block3,
          block1Output,
          block2Output,
          block3Output,
          pretty
        };
      },
    }).mount('#app');
  </script>
</body>
</html>
